<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Company Assessments</title>
  <link rel="stylesheet" href="/css/comp_style.css">
  <style>
    #selected {
      display: block;
      color: white;
      text-decoration: none;
      margin: 1rem 0;
      padding: 0.5rem;
      border: 1px solid white;
      border-radius: 4px;
    }

    .publish-btn,
    .unpublish-btn {
      background-color: #001242;
      color: white;
      border: none;
      padding: 0.3rem 0.6rem;
      margin: 0.2rem;
      cursor: pointer;
      border-radius: 4px;
    }

    .unpublish-btn {
      background-color: #dc3545;
    }

    .assessment-actions {
      margin-top: 1rem;
    }

    .published {
      background-color: #28a745;
    }

    .unpublished {
      background-color: #6c757d;
    }
  </style>
</head>

<body>
  <div class="sidebar">
    <div>
      <h2>Gradious</h2>
      <div id="selected"><a href="/comp_dashboard">Assessments</a></div>
    </div>
    <div>
      <div><a href="/add_users">Add Users</a></div>
      <div><a href="/admin_profile/<%= admin.admin_mail%>">Profile</a></div>
      <div><a href="/logout" style="color: white; text-decoration: none;">Logout</a></div>
    </div>
  </div>

  <div class="main-content">
    <div class="header-action">
      <a href="/comp_dashboard/create_quiz"><button>Create New</button></a>
    </div>
    <div class="assessment-grid">
      <% if (assessments && assessments.length> 0) { %>
        <% assessments.forEach(assessment=> { %>
          <div class="assessment-card">
            <h3>
              <%= assessment.assessment_name %>
            </h3>
            <p><strong>Assessment ID:</strong>
              <%= assessment.id %>
            </p>
            <p><strong>Total Questions:</strong>
              <%= assessment.total_questions %>
            </p>
            <p><strong>Total Marks:</strong>
              <%= assessment.total_marks %>
            </p>
            <p><strong>Passing Marks:</strong>
              <%= assessment.passing_marks %>
            </p>
            <p><strong>Time Limit:</strong>
              <%= assessment.time_limit %> minutes
            </p>
            <p><strong>Start Date:</strong>
              <%= new Date(assessment.start_date).toLocaleDateString() %>
            </p>
            <p><strong>End Date:</strong>
              <%= new Date(assessment.end_date).toLocaleDateString() %>
            </p>
            <p><strong>Published To:</strong>
              <%= Array.isArray(assessment.published_to) ? (assessment.published_to.includes('all') ? 'All Employees' :
                assessment.published_to.join(', ')) : ' All Employees' %>
            </p>
            <div class="status-label <%= assessment.is_published ? 'published' : 'unpublished' %>">
              <%= assessment.is_published ? 'Published' : 'Unpublished' %>
            </div>
            <div class="assessment-actions">
              <% if (assessment.is_published) { %>
                <button class="unpublish-btn" onclick="togglePublish('<%= assessment.id %>', false)">Unpublish</button>
                <% } else { %>
                  <button class="publish-btn" onclick="togglePublish('<%= assessment.id %>', true)">Publish</button>
                  <% } %>
                    <button class="publish-btn" onclick="viewAssessment('<%= assessment.id %>')">View</button>
                    <button class="unpublish-btn" onclick="deleteAssessment('<%= assessment.id %>')">Delete</button>
            </div>
          </div>
          <% }); %>
            <% } else { %>
              <div class="assessment-card">
                <h3>No Assessments Found</h3>
                <p>Create your first assessment to get started.</p>
              </div>
              <% } %>
    </div>
  </div>

  <script>

    function deleteAssessment(assessmentId) {
      console.log("Deleting:", assessmentId);
      if (confirm("Are you sure you want to delete this assessment?")) {
        fetch(`/delete_assessment/${assessmentId}`, {
          method: 'DELETE',
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              location.reload();
            } else {
              alert('Error deleting assessment');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error deleting assessment');
          });
      }
    }

    function togglePublish(assessmentId, publish) {
      fetch('/toggle_publish', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          assessment_id: assessmentId,
          is_published: publish
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            location.reload();
          } else {
            alert('Error updating assessment status');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error updating assessment status');
        });
    }

    function viewAssessment(assessmentId) {
      window.open(`/assessment/test/${assessmentId}`, '_blank');
    }
  </script>
</body>

</html>